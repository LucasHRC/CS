<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu Snake</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Jeu Snake</h1>
        <canvas id="snakeCanvas" width="400" height="400"></canvas>
        <p>Utilisez le joystick pour contrôler le serpent.</p>
        <footer>
            <a href="index.html">Retour à l'accueil</a>
        </footer>
    </div>

    <script>
        const canvas = document.getElementById('snakeCanvas');
        const ctx = canvas.getContext('2d');

        const gridSize = 20;
        let snake = [{ x: 10, y: 10 }];
        let direction = { x: 1, y: 0 };  // Direction par défaut : vers la droite
        let food = { x: 5, y: 5 };
        let snakeLength = 1;
        let gameSpeed = 200;  // Vitesse du jeu (200ms)

        // WebSocket configuration
        let connection = new WebSocket('ws://10.1.224.101:81/');  // Remplace par l'adresse IP de ton ESP32

        connection.onopen = () => {
            console.log("Connecté au serveur WebSocket");
        };

        connection.onerror = error => {
            console.error("Erreur WebSocket", error);
        };

        connection.onmessage = event => {
            const message = event.data;
            console.log("Message reçu du serveur:", message);

            // Changer la direction du serpent en fonction des mouvements du joystick
            if (message.includes("Joystick:Left") && direction.x === 0) {
                direction = { x: -1, y: 0 };  // Aller à gauche
            } else if (message.includes("Joystick:Right") && direction.x === 0) {
                direction = { x: 1, y: 0 };   // Aller à droite
            } else if (message.includes("Joystick:Down") && direction.y === 0) {
                direction = { x: 0, y: -1 };  // Inversé : Aller vers le haut (anciennement Down)
            } else if (message.includes("Joystick:Up") && direction.y === 0) {
                direction = { x: 0, y: 1 };   // Inversé : Aller vers le bas (anciennement Up)
            }
        };

        // Boucle de jeu
        function gameLoop() {
            // Mettre à jour la position du serpent
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };
            snake.unshift(head);

            // Vérifier si le serpent mange une pomme
            if (head.x === food.x && head.y === food.y) {
                food = { x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20) };
                snakeLength++;  // Le serpent grandit
            } else {
                snake.pop();  // Retirer la queue du serpent si la pomme n'est pas mangée
            }

            // Vérifier si le serpent sort des limites du canvas
            if (head.x < 0 || head.x >= canvas.width / gridSize || head.y < 0 || head.y >= canvas.height / gridSize) {
                resetGame();  // Réinitialiser le jeu si le serpent touche les bords
            }

            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dessiner la pomme
            ctx.fillStyle = '#D9ED92';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize, gridSize);

            // Dessiner le serpent
            ctx.fillStyle = '#34A0A4';
            snake.forEach(part => {
                ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize, gridSize);
            });
        }

        // Fonction pour réinitialiser le jeu
        function resetGame() {
            snake = [{ x: 10, y: 10 }];
            snakeLength = 1;
            direction = { x: 1, y: 0 };  // Réinitialiser la direction vers la droite
        }

        // Démarrer la boucle de jeu
        setInterval(gameLoop, gameSpeed);
    </script>
</body>
</html>
