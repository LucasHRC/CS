<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu Snake</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Jeu Snake</h1>
        <canvas id="snakeCanvas" width="400" height="400"></canvas>
        <p>État du joystick : <span id="joystickStatus">Center</span></p>
        <p>Score : <span id="score">0</span></p>

        <footer>
            <a href="index.html">Retour à l'accueil</a>
        </footer>
    </div>

    <script>
        const canvas = document.getElementById('snakeCanvas');
        const ctx = canvas.getContext('2d');

        const gridSize = 20;
        let snake = [{ x: 10, y: 10 }];
        let direction = { x: 1, y: 0 };
        let food = { x: 5, y: 5 };
        let gameSpeed = 200;
        let score = 0;

        const joystickStatusElement = document.getElementById('joystickStatus');
        const scoreElement = document.getElementById('score');

        // Création de la connexion WebSocket
        let connection = new WebSocket('ws://10.1.224.101:81/');

        connection.onopen = () => {
            console.log("Connecté au serveur WebSocket");
        };

        connection.onmessage = event => {
            const message = event.data.trim();
            console.log("Message reçu du serveur:", message);

            // Gestion de la direction du joystick
            if (message.includes("Joystick:Left") && direction.x === 0) {
                direction = { x: -1, y: 0 };
                joystickStatusElement.textContent = 'Left';
            } else if (message.includes("Joystick:Right") && direction.x === 0) {
                direction = { x: 1, y: 0 };
                joystickStatusElement.textContent = 'Right';
            } else if (message.includes("Joystick:Up") && direction.y === 0) {
                direction = { x: 0, y: 1 };  // Changement ici
                joystickStatusElement.textContent = 'Up';
            } else if (message.includes("Joystick:Down") && direction.y === 0) {
                direction = { x: 0, y: -1 };  // Changement ici
                joystickStatusElement.textContent = 'Down';
            } else if (message.includes("Joystick:Center")) {
                joystickStatusElement.textContent = 'Center';
            }
        };

        function gameLoop() {
            // Déplacement de la tête du serpent
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };
            snake.unshift(head);

            // Vérification si le serpent mange la nourriture
            if (head.x === food.x && head.y === food.y) {
                food = {
                    x: Math.floor(Math.random() * (canvas.width / gridSize)),
                    y: Math.floor(Math.random() * (canvas.height / gridSize))
                };
                score++;
                scoreElement.textContent = score;
            } else {
                snake.pop();
            }

            // Détection de collision avec les murs ou le corps du serpent
            if (head.x < 0 || head.x >= canvas.width / gridSize || head.y < 0 || head.y >= canvas.height / gridSize || collisionWithSelf()) {
                resetGame();
            }

            // Affichage du jeu
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#D9ED92'; // Couleur de la nourriture
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize, gridSize);
            ctx.fillStyle = '#34A0A4'; // Couleur du serpent
            snake.forEach(part => {
                ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize, gridSize);
            });
        }

        function collisionWithSelf() {
            // Vérifie si la tête du serpent entre en collision avec son corps
            return snake.slice(1).some(part => part.x === snake[0].x && part.y === snake[0].y);
        }

        function resetGame() {
            snake = [{ x: 10, y: 10 }];
            direction = { x: 1, y: 0 };
            score = 0;
            scoreElement.textContent = score;
            food = {
                x: Math.floor(Math.random() * (canvas.width / gridSize)),
                y: Math.floor(Math.random() * (canvas.height / gridSize))
            };
        }

        setInterval(gameLoop, gameSpeed);
    </script>
</body>
</html>
